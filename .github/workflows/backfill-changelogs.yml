name: Backfill Changelogs

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run without making changes'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  backfill:
    name: Backfill Release Notes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-cliff
        uses: taiki-e/install-action@git-cliff

      - name: Backfill Changelogs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -e

          echo "Fetching all tags..."
          git fetch --tags

          # Get all version tags, sorted by version
          # Assuming v* format
          TAGS=$(git tag -l "v*" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sort -V)

          PREV_TAG=""

          for TAG in $TAGS; do
            echo "Processing tag: $TAG"
            
            # Check if release exists
            if ! gh release view "$TAG" > /dev/null 2>&1; then
              echo "  Release not found for $TAG, skipping (create releases manually if needed first)"
              PREV_TAG="$TAG"
              continue
            fi

            # Check if body is empty (or we just want to overwrite? Let's assume overwrite/fill for now based on user request "create... that don't have any")
            # But "don't have any" implies checking content.
            BODY=$(gh release view "$TAG" --json body -q .body)

            # Trim whitespace
            BODY=$(echo "$BODY" | xargs)

            if [ -n "$BODY" ]; then
               echo "  Release notes already exist for $TAG (content length: ${#BODY}). Skipping."
               PREV_TAG="$TAG"
               continue
            fi

            echo "  No release notes found for $TAG. Generating..."

            if [ -z "$PREV_TAG" ]; then
              # First tag, from beginning of history
              RANGE="$TAG"
            else
              RANGE="$PREV_TAG..$TAG"
            fi
            
            echo "  Generating changelog for range: $RANGE"
            
            # Generate changelog for this specific range
            # We strip the header because connection to next tag isn't relevant for single release notes
            git cliff --config cliff.toml --strip header "$RANGE" > RELEASE_NOTES_TMP.md

            if [ "$DRY_RUN" = "true" ]; then
              echo "  [DRY RUN] Would update release $TAG with content:"
              cat RELEASE_NOTES_TMP.md
            else
              echo "  Updating release $TAG..."
              gh release edit "$TAG" --notes-file RELEASE_NOTES_TMP.md
            fi

            rm RELEASE_NOTES_TMP.md
            PREV_TAG="$TAG"
          done
